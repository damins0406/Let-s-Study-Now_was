<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Chat Full Feature Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; background-color: #f4f4f4; }
        .container { display: flex; gap: 20px; }
        .left-panel { flex: 1; }
        .right-panel { flex: 1; }

        .input-group { margin-bottom: 15px; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h3 { margin-top: 0; color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; color: #555; }
        input[type="text"], select, input[type="number"] { padding: 8px; width: 100%; box-sizing: border-box; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; }

        button { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        .btn-connect { background-color: #4CAF50; }
        .btn-send { background-color: #2196F3; }
        .btn-solve { background-color: #9C27B0; }
        button:hover { opacity: 0.9; }

        #chat-area {
            list-style-type: none; padding: 10px; margin: 0;
            border: 1px solid #ccc; height: 600px; overflow-y: scroll;
            background: white; border-radius: 8px;
        }
        #chat-area li { padding: 8px; border-bottom: 1px solid #eee; font-size: 0.9em; }

        /* ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .msg-SYSTEM { color: #d32f2f; font-weight: bold; background-color: #ffebee; text-align: center; }
        .msg-QUESTION { background-color: #e3f2fd; border-left: 4px solid #2196F3; }
        .msg-ANSWER { background-color: #f1f8e9; border-left: 4px solid #8bc34a; margin-left: 20px; }
        .msg-SOLVE { background-color: #fff3e0; color: #ef6c00; font-weight: bold; text-align: center; }

        .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; color: white; margin-right: 5px; }
        .bg-q { background-color: #2196F3; }
        .bg-a { background-color: #8bc34a; }

        .chat-image { max-width: 150px; border-radius: 5px; display: block; margin-top: 5px; }
    </style>
</head>
<body>

<h2>ğŸ§ª ì±„íŒ… & ì§ˆë¬¸í•´ê²° í†µí•© í…ŒìŠ¤íŠ¸</h2>

<div class="input-group">
    <label>ğŸ”‘ JWT Token (Bearer ì—†ì´):</label>
    <input type="text" id="jwtToken" placeholder="ë¡œê·¸ì¸ í›„ ë°›ì€ í† í° ë¶™ì—¬ë„£ê¸°...">
</div>

<div class="container">
    <div class="left-panel">

        <div class="input-group">
            <h3>1. ë°© ì…ì¥</h3>
            <label>ë°© ë²ˆí˜¸ / íƒ€ì…:</label>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="roomId" value="1" style="width: 50%;">
                <select id="roomType" style="width: 50%;">
                    <option value="OPEN">OPEN</option>
                    <option value="GROUP">GROUP</option>
                </select>
            </div>
            <button onclick="connect()" class="btn-connect">ğŸ”Œ ì†Œì¼“ ì—°ê²°</button>
            <button onclick="disconnect()" style="background-color: #666;">âŒ í•´ì œ</button>
            <span id="status" style="color: red; font-weight: bold; margin-left: 10px;">OFF</span>
        </div>

        <div class="input-group">
            <h3>2. ë©”ì‹œì§€ ë³´ë‚´ê¸°</h3>
            <label>ë©”ì‹œì§€ íƒ€ì…:</label>
            <select id="msgType" onchange="toggleRefId()">
                <option value="TALK">ğŸ’¬ ì¼ë°˜ ëŒ€í™” (TALK)</option>
                <option value="QUESTION">â“ ì§ˆë¬¸ í•˜ê¸° (QUESTION)</option>
                <option value="ANSWER">ğŸ’¡ ë‹µë³€ ë‹¬ê¸° (ANSWER)</option>
            </select>

            <div id="refIdGroup" style="display: none; background: #eee; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                <label>ì–´ë–¤ ì§ˆë¬¸ì— ëŒ€í•œ ë‹µë³€ì¸ê°€ìš”? (ì§ˆë¬¸ ID):</label>
                <input type="number" id="refId" placeholder="ì§ˆë¬¸ ë©”ì‹œì§€ì˜ ID ì…ë ¥">
            </div>

            <label>ë‚´ìš©:</label>
            <input type="text" id="message" value="ì•ˆë…•í•˜ì„¸ìš”">
            <button onclick="sendMessage()" class="btn-send">ğŸ“¤ ì „ì†¡</button>
        </div>

        <div class="input-group" style="border: 2px solid #9C27B0;">
            <h3 style="color: #9C27B0;">3. ğŸ‘‘ í•´ê²° ë° ì±„íƒ (HTTP API)</h3>
            <p style="font-size: 0.8em; color: #666;">* ë³¸ì¸ì´ ì‘ì„±í•œ ì§ˆë¬¸ë§Œ í•´ê²° ê°€ëŠ¥</p>

            <label>í•´ê²°í•  ì§ˆë¬¸ ID (í•„ìˆ˜):</label>
            <input type="number" id="solveQuestionId" placeholder="ì˜ˆ: 10">

            <label>ì±„íƒí•  ë‹µë³€ ID (ì„ íƒ):</label>
            <input type="number" id="solveAnswerId" placeholder="ì˜ˆ: 11 (ì—†ìœ¼ë©´ ë‹¨ìˆœí•´ê²°)">

            <button onclick="callSolveApi()" class="btn-solve">âœ¨ í•´ê²°/ì±„íƒ ìš”ì²­</button>
        </div>

        <div class="input-group">
            <h3>4. ì´ë¯¸ì§€ ì „ì†¡</h3>
            <input type="file" id="imageInput" accept="image/*">
            <button onclick="sendImage()" style="background-color: #FF9800;">ğŸ“· ì—…ë¡œë“œ & ì „ì†¡</button>
        </div>
    </div>

    <div class="right-panel">
        <ul id="chat-area">
            <li style="text-align: center; color: #999;">ì±„íŒ… ë‚´ì—­ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</li>
        </ul>
    </div>
</div>

<script>
    var stompClient = null;

    function getToken() { return document.getElementById("jwtToken").value.trim(); }

    function toggleRefId() {
        var type = document.getElementById("msgType").value;
        document.getElementById("refIdGroup").style.display = (type === 'ANSWER') ? 'block' : 'none';
    }

    function connect() {
        var token = getToken();
        if (!token) { alert("í† í°ì„ ì…ë ¥í•˜ì„¸ìš”."); return; }

        var socket = new SockJS('http://localhost:8080/ws-stomp');
        stompClient = Stomp.over(socket);

        var headers = { 'Authorization': 'Bearer ' + token };

        stompClient.connect(headers, function (frame) {
            console.log('Connected: ' + frame);
            document.getElementById("status").innerText = "ON";
            document.getElementById("status").style.color = "green";
            document.getElementById("chat-area").innerHTML = ""; // ì´ˆê¸°í™”

            var roomId = document.getElementById("roomId").value;
            var roomType = document.getElementById("roomType").value;

            // êµ¬ë…
            stompClient.subscribe('/sub/chat/' + roomType.toLowerCase() + '/' + roomId, function (res) {
                showChat(JSON.parse(res.body));
            });

            // ì…ì¥
            stompClient.send("/pub/chat/message", headers, JSON.stringify({
                'type': 'ENTER',
                'roomType': roomType,
                'roomId': roomId,
                'message': ''
            }));

        }, function(err) {
            alert("ì—°ê²° ì‹¤íŒ¨");
            console.error(err);
        });
    }

    function sendMessage() {
        if (!stompClient) return;

        var type = document.getElementById("msgType").value;
        var message = document.getElementById("message").value;
        var roomId = document.getElementById("roomId").value;
        var roomType = document.getElementById("roomType").value;
        var refId = document.getElementById("refId").value; // ë‹µë³€ì¼ ë•Œë§Œ ê°’ ìˆìŒ

        var payload = {
            'type': type,
            'roomType': roomType,
            'roomId': roomId,
            'message': message
        };

        if(type === 'ANSWER') {
            if(!refId) { alert("ë‹µë³€ì—ëŠ” ì§ˆë¬¸ IDê°€ í•„ìš”í•©ë‹ˆë‹¤!"); return; }
            payload.refId = refId;
        }

        stompClient.send("/pub/chat/message",
            { 'Authorization': 'Bearer ' + getToken() },
            JSON.stringify(payload)
        );

        document.getElementById("message").value = "";
    }

    // â˜… ìˆ˜ì •ëœ callSolveApi í•¨ìˆ˜
    function callSolveApi() {
        var questionId = document.getElementById("solveQuestionId").value;
        var answerId = document.getElementById("solveAnswerId").value;
        var token = getToken();

        if(!questionId) { alert("í•´ê²°í•  ì§ˆë¬¸ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; }

        var url = `http://localhost:8080/api/chat/message/${questionId}/solve`;

        // ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬
        if(answerId) {
            url += `?answerId=${answerId}`;
        }

        fetch(url, {
            method: 'PATCH',
            headers: {
                'Authorization': 'Bearer ' + token
                // 'Content-Type': 'application/json'  <-- â˜… ì´ ì¤„ì„ ì§€ìš°ì„¸ìš”! Bodyê°€ ì—†ìœ¼ë©´ ì•ˆ ë³´ë‚´ëŠ” ê²Œ ë§ìŠµë‹ˆë‹¤.
            }
        })
        .then(async response => {
            if(response.ok) {
                alert("ì„±ê³µ! ì±„íŒ…ì°½ì„ í™•ì¸í•˜ì„¸ìš”.");
            } else {
                // ì—ëŸ¬ ë©”ì‹œì§€ í™•ì¸
                var txt = await response.text();
                console.error("ì—ëŸ¬ ë‚´ìš©:", txt); // ì½˜ì†”ì—ë„ ì¶œë ¥
                alert("ì‹¤íŒ¨: " + txt);
            }
        })
        .catch(err => console.error(err));
    }

    // â˜… ì´ë¯¸ì§€ ì „ì†¡ (ì™„ì „í•œ ì½”ë“œ ì¶”ê°€ë¨)
    function sendImage() {
        if (!stompClient || !stompClient.connected) {
            alert("ë¨¼ì € ì—°ê²°í•´ì£¼ì„¸ìš”!");
            return;
        }

        var fileInput = document.getElementById('imageInput');
        var file = fileInput.files[0];
        if (!file) {
            alert("íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.");
            return;
        }

        var formData = new FormData();
        formData.append("file", file);

        fetch('/api/chat/image', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + getToken()
            },
            body: formData
        })
        .then(response => {
            if (!response.ok) throw new Error("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨");
            return response.text();
        })
        .then(imageUrl => {
            console.log("ì—…ë¡œë“œ ì„±ê³µ:", imageUrl);

            var roomId = document.getElementById("roomId").value;
            var roomType = document.getElementById("roomType").value;
            var headers = { 'Authorization': 'Bearer ' + getToken() };

            stompClient.send("/pub/chat/message", headers, JSON.stringify({
                'type': 'IMAGE',
                'roomType': roomType,
                'roomId': roomId,
                'message': imageUrl
            }));

            fileInput.value = '';
            alert("ì´ë¯¸ì§€ ì „ì†¡ ì™„ë£Œ");
        })
        .catch(error => {
            console.error("Error:", error);
            alert("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
        });
    }

    // ì±„íŒ… í™”ë©´ ê·¸ë¦¬ê¸° (ì™„ì „í•œ ì½”ë“œ)
    function showChat(msg) {
        var chatArea = document.getElementById("chat-area");
        var li = document.createElement("li");

        // ë©”ì‹œì§€ ID í‘œì‹œ (í…ŒìŠ¤íŠ¸ìš©)
        var idBadge = msg.messageId ? `[ID:${msg.messageId}] ` : '';

        // íƒ€ì…ë³„ ìŠ¤íƒ€ì¼ ì ìš©
        li.className = "msg-" + msg.type;

        if (msg.type === 'QUESTION') {
            li.innerHTML = `${idBadge}<span class="badge bg-q">ì§ˆë¬¸</span> <strong>${msg.sender}</strong>: ${msg.message} (ë¯¸í•´ê²°)`;
        } else if (msg.type === 'ANSWER') {
            var selectedMark = msg.isSelected ? "ğŸ‘‘(ì±„íƒë¨) " : "";
            li.innerHTML = `${idBadge}â†³ <span class="badge bg-a">ë‹µë³€</span>(to ID:${msg.refId}) <strong>${msg.sender}</strong>: ${selectedMark}${msg.message}`;
        } else if (msg.type === 'SOLVE') {
            li.innerHTML = `ğŸ‰ <strong>SYSTEM</strong>: ${msg.message} (ì§ˆë¬¸ID: ${msg.messageId})`;
        } else if (msg.type === 'IMAGE') {
            li.innerHTML = `${idBadge}<strong>${msg.sender}</strong>: <img src="${msg.message}" class="chat-image">`;
        } else {
            // ENTER, TALK
            li.innerHTML = `${idBadge}<strong>${msg.sender}</strong>: ${msg.message}`;
        }

        chatArea.appendChild(li);
        chatArea.scrollTop = chatArea.scrollHeight;
    }

    function disconnect() {
        if(stompClient) stompClient.disconnect();
        document.getElementById("status").innerText="OFF";
        document.getElementById("status").style.color = "red";
    }
</script>
</body>
</html>